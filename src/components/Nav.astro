---
import Icon from './Icon.astro'
import type { iconPaths } from './IconPaths'
import ThemeToggle from './ThemeToggle.astro'

/** Main menu items */
const textLinks: { label: string; href: string }[] = [
  { label: 'Home', href: '/' },
  { label: 'Work', href: '/work/' },
  { label: 'About', href: '/about/' }
]

/** Icon links to social media â€” edit these with links to your profiles! */
const iconLinks: { label: string; href: string; icon: keyof typeof iconPaths }[] = [
  { label: 'Twitter', href: 'https://twitter.com/me', icon: 'twitter-logo' },
  { label: 'Twitch', href: 'https://twitch.tv/me', icon: 'twitch-logo' },
  { label: 'GitHub', href: 'https://github.com/me', icon: 'github-logo' },
  { label: 'CodePen', href: 'https://codepen.io/me', icon: 'codepen-logo' },
  { label: 'dribbble', href: 'https://dribbble.com/me', icon: 'dribbble-logo' },
  { label: 'YouTube', href: 'https://www.youtube.com/@me/', icon: 'youtube-logo' }
]

/** Test if a link is pointing to the current page. */
const isCurrentPage = (href: string) => {
  let pathname = Astro.url.pathname.replace(import.meta.env.BASE_URL, '')
  if (pathname.at(0) !== '/') pathname = '/' + pathname
  if (pathname.at(-1) !== '/') pathname += '/'
  return pathname === href || (href !== '/' && pathname.startsWith(href))
}
---

<nav role="navigation" aria-label="Main navigation">
  <div class="menu-header">
    <a href="/" class="site-title animate-glow" aria-label="Omar Torres - Home">
      <Icon icon="terminal-window" color="#00ffff" size="1.6em" gradient />
      <span class="text-neon-cyan">Omar Torres</span>
    </a>
    <menu-button>
      <template>
        <button 
          class="menu-button" 
          aria-expanded="false"
          aria-controls="menu-content"
          aria-label="Toggle navigation menu"
        >
          <span class="sr-only">Menu</span>
          <Icon icon="list" />
        </button>
      </template>
    </menu-button>
  </div>
  <noscript>
    <ul class="nav-items" role="list">
      {
        textLinks.map(({ label, href }) => (
          <li role="listitem">
            <a 
              aria-current={isCurrentPage(href) ? 'page' : null} 
              class="link" 
              href={href}
              tabindex="0"
            >
              {label}
            </a>
          </li>
        ))
      }
    </ul>
  </noscript>
  <noscript>
    <div class="menu-footer">
      <nav class="socials" role="navigation" aria-label="Social media links">
        {
          iconLinks.map(({ href, icon, label }) => (
            <a 
              href={href} 
              class="social"
              aria-label={`${label} (opens in new tab)`}
              target="_blank"
              rel="noopener noreferrer"
              tabindex="0"
            >
              <span class="sr-only">{label}</span>
              <Icon icon={icon} />
            </a>
          ))
        }
      </nav>
    </div>
  </noscript>
  <div id="menu-content" hidden>
    <ul class="nav-items" role="list">
      {
        textLinks.map(({ label, href }) => (
          <li role="listitem">
            <a 
              aria-current={isCurrentPage(href) ? 'page' : null} 
              class="link" 
              href={href}
              tabindex="0"
            >
              {label}
            </a>
          </li>
        ))
      }
    </ul>
    <div class="menu-footer">
      <nav class="socials" role="navigation" aria-label="Social media links">
        {
          iconLinks.map(({ href, icon, label }) => (
            <a 
              href={href} 
              class="social"
              aria-label={`${label} (opens in new tab)`}
              target="_blank"
              rel="noopener noreferrer"
              tabindex="0"
            >
              <span class="sr-only">{label}</span>
              <Icon icon={icon} />
            </a>
          ))
        }
      </nav>

      <div class="theme-toggle">
        <ThemeToggle />
      </div>
    </div>
  </div>
</nav>

<script>
  class MenuButton extends HTMLElement {
    constructor() {
      super()

      // Inject menu toggle button when JS runs.
      this.appendChild(this.querySelector('template')!.content.cloneNode(true))
      const btn = this.querySelector('button')!

      // Hide menu (shown by default to support no-JS browsers).
      const menu = document.getElementById('menu-content')!
      menu.hidden = true
      // Add "menu-content" class in JS to avoid covering content in non-JS browsers.
      menu.classList.add('menu-content')

      /** Set whether the menu is currently expanded or collapsed. */
      const setExpanded = (expand: boolean) => {
        btn.setAttribute('aria-expanded', expand ? 'true' : 'false')
        menu.hidden = !expand
      }

      // Toggle menu visibility when the menu button is clicked.
      btn.addEventListener('click', () => setExpanded(menu.hidden))

      // Keyboard navigation support
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault()
          setExpanded(menu.hidden)
        }
        if (e.key === 'Escape' && !menu.hidden) {
          setExpanded(false)
          btn.focus()
        }
      })

      // Close menu on escape key anywhere in the document
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !menu.hidden) {
          setExpanded(false)
          btn.focus()
        }
      })

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!menu.hidden && !menu.contains(e.target as Node) && !btn.contains(e.target as Node)) {
          setExpanded(false)
        }
      })

      // Focus management for menu items
      const menuLinks = menu.querySelectorAll('a')
      menu.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          // Allow normal tab behavior
          return
        }
        
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault()
          const currentIndex = Array.from(menuLinks).indexOf(e.target as HTMLAnchorElement)
          let nextIndex = currentIndex
          
          if (e.key === 'ArrowDown') {
            nextIndex = currentIndex + 1 >= menuLinks.length ? 0 : currentIndex + 1
          } else {
            nextIndex = currentIndex - 1 < 0 ? menuLinks.length - 1 : currentIndex - 1
          }
          
          menuLinks[nextIndex].focus()
        }
      })

      // Hide menu button for large screens.
      const handleViewports = (e: MediaQueryList | MediaQueryListEvent) => {
        setExpanded(e.matches)
        btn.hidden = e.matches
      }
      const mediaQueries = window.matchMedia('(min-width: 50em)')
      handleViewports(mediaQueries)
      mediaQueries.addEventListener('change', handleViewports)
    }
  }
  customElements.define('menu-button', MenuButton)
</script>

<!-- Analytics tracking for navigation interactions -->
<script define:vars={{ textLinks, iconLinks }}>
// Navigation analytics tracking
document.addEventListener('DOMContentLoaded', function() {
  // Wait for analytics to be ready
  function initializeNavigationTracking() {
    if (!window.analytics?.trackNavigationClick) {
      // Analytics not ready yet, try again in 100ms
      setTimeout(initializeNavigationTracking, 100);
      return;
    }

    // Track menu button interactions
    const menuButton = document.querySelector('.menu-button');
    const menuContent = document.getElementById('menu-content');

    if (menuButton && menuContent) {
      let menuOpenTime = null;

      menuButton.addEventListener('click', () => {
        const isExpanding = menuContent.hidden;

        if (isExpanding) {
          window.analytics.trackNavigationClick('menu_open', false, {
            source: 'navigation',
            interactionType: 'menu_toggle',
            viewport: window.innerWidth <= 800 ? 'mobile' : 'desktop'
          });
          menuOpenTime = Date.now();
        } else {
          const timeOpen = menuOpenTime ? Date.now() - menuOpenTime : 0;
          window.analytics.trackNavigationClick('menu_close', false, {
            source: 'navigation',
            interactionType: 'menu_toggle',
            timeOpen: timeOpen,
            viewport: window.innerWidth <= 800 ? 'mobile' : 'desktop'
          });
          menuOpenTime = null;
        }
      });
    }

    // Track site title/logo clicks
    const siteTitle = document.querySelector('.site-title');
    if (siteTitle) {
      siteTitle.addEventListener('click', (e) => {
        window.analytics.trackNavigationClick(e.target.href, false, {
          source: 'navigation',
          linkType: 'site_title',
          linkText: 'Omar Torres',
          viewport: window.innerWidth <= 800 ? 'mobile' : 'desktop'
        });
      });
    }

    // Track main navigation links
    const navLinks = document.querySelectorAll('.nav-items .link');
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        const linkText = e.target.textContent.trim();
        const href = e.target.href;
        const isExternal = href.startsWith('http') && !href.includes(window.location.hostname);
        const isCurrentPage = e.target.getAttribute('aria-current') === 'page';

        window.analytics.trackNavigationClick(href, isExternal, {
          source: 'navigation',
          linkType: 'main_nav',
          linkText: linkText,
          isCurrentPage: isCurrentPage,
          destination: href,
          viewport: window.innerWidth <= 800 ? 'mobile' : 'desktop',
          menuState: menuContent && !menuContent.hidden ? 'open' : 'closed'
        });

        // Close mobile menu after navigation
        if (menuContent && !menuContent.hidden && window.innerWidth <= 800) {
          setTimeout(() => {
            if (menuButton) {
              menuButton.click();
            }
          }, 100);
        }
      });
    });

    // Track social media link clicks
    const socialLinks = document.querySelectorAll('.social');
    socialLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        const href = e.target.closest('a').href;
        const ariaLabel = e.target.closest('a').getAttribute('aria-label') || '';
        const socialPlatform = ariaLabel.split(' ')[0].toLowerCase(); // Extract platform name

        window.analytics.trackNavigationClick(href, true, {
          source: 'navigation',
          linkType: 'social_media',
          platform: socialPlatform,
          destination: href,
          viewport: window.innerWidth <= 800 ? 'mobile' : 'desktop',
          menuState: menuContent && !menuContent.hidden ? 'open' : 'closed'
        });
      });
    });

    // Track keyboard navigation usage
    let keyboardNavigationActive = false;
    document.addEventListener('keydown', (e) => {
      if (['Tab', 'ArrowUp', 'ArrowDown', 'Enter', 'Space', 'Escape'].includes(e.key)) {
        if (!keyboardNavigationActive) {
          window.analytics.trackNavigationClick('keyboard_navigation_start', false, {
            source: 'navigation',
            interactionType: 'keyboard_navigation',
            firstKey: e.key,
            viewport: window.innerWidth <= 800 ? 'mobile' : 'desktop'
          });
          keyboardNavigationActive = true;
        }
      }
    });

    // Track focus on navigation elements
    const focusableElements = document.querySelectorAll('.link, .social, .menu-button');
    focusableElements.forEach(element => {
      element.addEventListener('focus', (e) => {
        const elementType = e.target.classList.contains('link') ? 'nav_link' :
                           e.target.classList.contains('social') ? 'social_link' :
                           'menu_button';

        window.analytics.trackNavigationClick('element_focus', false, {
          source: 'navigation',
          interactionType: 'focus',
          elementType: elementType,
          linkText: e.target.textContent?.trim() || e.target.getAttribute('aria-label') || '',
          viewport: window.innerWidth <= 800 ? 'mobile' : 'desktop'
        });
      });
    });

    // Track viewport changes affecting navigation
    let currentViewport = window.innerWidth <= 800 ? 'mobile' : 'desktop';
    window.addEventListener('resize', () => {
      const newViewport = window.innerWidth <= 800 ? 'mobile' : 'desktop';
      if (newViewport !== currentViewport) {
        window.analytics.trackNavigationClick('viewport_change', false, {
          source: 'navigation',
          interactionType: 'responsive_change',
          fromViewport: currentViewport,
          toViewport: newViewport,
          windowWidth: window.innerWidth
        });
        currentViewport = newViewport;
      }
    });

    // Track navigation visibility (for performance)
    const navElement = document.querySelector('nav');
    if (navElement) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            window.analytics.trackNavigationClick('navigation_view', false, {
              source: 'navigation',
              interactionType: 'view',
              viewportPosition: Math.round(entry.boundingClientRect.top),
              viewport: window.innerWidth <= 800 ? 'mobile' : 'desktop'
            });
            // Only track once per page load
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.5 });

      observer.observe(navElement);
    }

    console.log('[Analytics] Navigation tracking initialized');
  }

  // Initialize tracking when DOM is ready
  initializeNavigationTracking();

  // Also listen for analytics ready event
  window.addEventListener('analyticsReady', initializeNavigationTracking);
});
</script>

<style>
  nav {
    z-index: 9999;
    position: relative;
    font-family: var(--font-brand);
    font-weight: 500;
    margin-bottom: 3.5rem;
  }

  .menu-header {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 1.5rem;
  }

  .site-title {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    line-height: 1.1;
    color: var(--gray-0);
    text-decoration: none;
  }

  .menu-button {
    position: relative;
    display: flex;
    border: 0;
    border-radius: 999rem;
    padding: 0.5rem;
    font-size: 1.5rem;
    color: var(--gray-300);
    background: radial-gradient(var(--gray-900), var(--gray-800) 150%);
    box-shadow: var(--shadow-md);
  }

  .menu-button[aria-expanded='true'] {
    color: var(--gray-0);
    background:
      linear-gradient(180deg, var(--gray-600), transparent),
      radial-gradient(var(--gray-900), var(--gray-800) 150%);
  }

  .menu-button[hidden] {
    display: none;
  }

  .menu-button::before {
    position: absolute;
    inset: -1px;
    content: '';
    background: var(--gradient-stroke);
    border-radius: 999rem;
    z-index: -1;
  }

  .menu-content {
    position: absolute;
    left: 0;
    right: 0;
  }

  .nav-items {
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    font-size: var(--text-md);
    line-height: 1.2;
    list-style: none;
    padding: 2rem;
    background-color: var(--gray-999);
    border-bottom: 1px solid var(--gray-800);
  }

  .link {
    display: inline-block;
    color: var(--gray-300);
    text-decoration: none;
  }

  .link[aria-current] {
    color: var(--gray-0);
  }

  .menu-footer {
    --icon-size: var(--text-xl);
    --icon-padding: 0.5rem;

    display: flex;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 1.5rem 2rem 1.5rem 1.5rem;
    background-color: var(--gray-999);
    border-radius: 0 0 0.75rem 0.75rem;
    box-shadow: var(--shadow-lg);
  }

  .socials {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem;
    font-size: var(--icon-size);
  }

  .social {
    display: flex;
    padding: var(--icon-padding);
    text-decoration: none;
    color: var(--accent-dark);
    transition: color var(--theme-transition);
  }

  .social:hover,
  .social:focus {
    color: var(--accent-text-over);
  }

  .theme-toggle {
    display: flex;
    align-items: center;
    height: calc(var(--icon-size) + 2 * var(--icon-padding));
  }

  @media (min-width: 50em) {
    nav {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 2.5rem 5rem;
      gap: 1rem;
    }

    .menu-header {
      padding: 0;
    }

    .site-title {
      font-size: var(--text-lg);
    }

    .menu-content {
      display: contents;
    }

    .nav-items {
      position: relative;
      flex-direction: row;
      font-size: var(--text-sm);
      border-radius: 999rem;
      border: 0;
      padding: 0.5rem 0.5625rem;
      background: radial-gradient(var(--gray-900), var(--gray-800) 150%);
      box-shadow: var(--shadow-md);
    }

    .nav-items::before {
      position: absolute;
      inset: -1px;
      content: '';
      background: var(--gradient-stroke);
      border-radius: 999rem;
      z-index: -1;
    }

    .link {
      padding: 0.5rem 1rem;
      border-radius: 999rem;
      transition:
        color var(--theme-transition),
        background-color var(--theme-transition);
    }

    .link:hover,
    .link:focus {
      color: var(--gray-100);
      background-color: var(--accent-subtle-overlay);
    }

    .link[aria-current='page'] {
      color: var(--accent-text-over);
      background-color: var(--accent-regular);
    }

    .menu-footer {
      --icon-padding: 0.375rem;

      justify-self: flex-end;
      align-items: center;
      padding: 0;
      background-color: transparent;
      box-shadow: none;
    }

    .socials {
      display: none;
    }
  }

  @media (min-width: 60em) {
    .socials {
      display: flex;
      justify-content: flex-end;
      gap: 0;
    }
  }
  /* Focus indicators for better accessibility */
  .link:focus-visible,
  .social:focus-visible,
  .menu-button:focus-visible {
    outline: 2px solid #00ffff;
    outline-offset: 2px;
    border-radius: 4px;
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .link,
    .social {
      border: 1px solid transparent;
    }
    
    .link:focus-visible,
    .social:focus-visible {
      border-color: currentColor;
      outline-width: 3px;
    }
    
    .menu-button {
      border: 2px solid currentColor;
    }
  }

  /* Reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .link,
    .social,
    .menu-button {
      transition: none !important;
    }
  }

  /* Screen reader only content */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Skip to content when focused */
  .sr-only:focus {
    position: static;
    width: auto;
    height: auto;
    padding: 0.5rem;
    margin: 0;
    overflow: visible;
    clip: auto;
    white-space: normal;
    background: var(--gray-999);
    color: var(--accent-text-over);
    border: 2px solid #00ffff;
    border-radius: 4px;
    z-index: 1000;
  }

  @media (forced-colors: active) {
    .link[aria-current='page'] {
      color: SelectedItem;
    }
    
    .menu-button,
    .link,
    .social {
      forced-color-adjust: none;
      border-color: ButtonText;
    }
  }
</style>
