---
/**
 * PrivacyBanner.astro - Lightweight Privacy Notification Banner
 *
 * Simple, non-intrusive privacy banner for initial consent collection.
 * Based on: specs/057-advanced-analytics-monitoring/research.md
 * Feature: 057-advanced-analytics-monitoring
 * Generated: 2025-09-17
 */

export interface Props {
  variant?: 'minimal' | 'standard' | 'detailed';
  position?: 'bottom' | 'top';
  theme?: 'dark' | 'light' | 'auto';
  showCloseButton?: boolean;
  autoHide?: boolean;
  autoHideDelay?: number;
}

const {
  variant = 'standard',
  position = 'bottom',
  theme = 'auto',
  showCloseButton = true,
  autoHide = false,
  autoHideDelay = 10000
} = Astro.props;

// Generate unique ID for this banner instance
const bannerId = `privacy-banner-${Math.random().toString(36).substr(2, 9)}`;
---

<!-- Privacy Banner Container -->
<div
  id={bannerId}
  class="privacy-banner"
  data-testid="privacy-banner"
  data-variant={variant}
  data-position={position}
  data-theme={theme}
  role="region"
  aria-label="Privacy Notice"
  aria-live="polite"
  hidden
>
  <div class="privacy-banner-content">
    <!-- Banner Icon (Minimal & Standard) -->
    {(variant === 'minimal' || variant === 'standard') && (
      <div class="privacy-banner-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <circle cx="12" cy="16" r="1"></circle>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      </div>
    )}

    <!-- Banner Text Content -->
    <div class="privacy-banner-text">
      {variant === 'minimal' && (
        <p class="privacy-banner-message">
          This site uses cookies to enhance your experience.
          <a href="/privacy-policy" class="privacy-banner-link" target="_blank" rel="noopener">Privacy Policy</a>
        </p>
      )}

      {variant === 'standard' && (
        <div class="privacy-banner-message">
          <p>
            <strong>Your Privacy Matters</strong> - We use cookies and similar technologies to improve your experience,
            analyze site usage, and personalize content.
          </p>
          <p class="privacy-banner-submessage">
            You can manage your preferences at any time.
            <a href="/privacy-policy" class="privacy-banner-link" target="_blank" rel="noopener">Learn more</a>
          </p>
        </div>
      )}

      {variant === 'detailed' && (
        <div class="privacy-banner-message">
          <h3 class="privacy-banner-title">Privacy & Cookie Notice</h3>
          <p>
            We respect your privacy and are committed to protecting your personal data. This website uses cookies
            and similar technologies to:
          </p>
          <ul class="privacy-banner-list">
            <li>Ensure the website functions properly (essential cookies)</li>
            <li>Analyze how you use our website to improve performance</li>
            <li>Remember your preferences and settings</li>
            <li>Provide personalized content and recommendations</li>
          </ul>
          <p class="privacy-banner-footer">
            By continuing to use this site, you consent to our use of cookies. You can change your cookie preferences
            at any time. For more information, please read our
            <a href="/privacy-policy" class="privacy-banner-link" target="_blank" rel="noopener">Privacy Policy</a> and
            <a href="/cookie-policy" class="privacy-banner-link" target="_blank" rel="noopener">Cookie Policy</a>.
          </p>
        </div>
      )}
    </div>

    <!-- Banner Actions -->
    <div class="privacy-banner-actions">
      {variant === 'minimal' && (
        <div class="privacy-banner-actions-minimal">
          <button
            type="button"
            class="privacy-banner-btn privacy-banner-btn-primary"
            data-action="accept"
            data-testid="accept-btn"
          >
            Accept
          </button>
          {showCloseButton && (
            <button
              type="button"
              class="privacy-banner-btn privacy-banner-btn-close"
              data-action="close"
              data-testid="close-btn"
              aria-label="Close privacy notice"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          )}
        </div>
      )}

      {variant === 'standard' && (
        <div class="privacy-banner-actions-standard">
          <button
            type="button"
            class="privacy-banner-btn privacy-banner-btn-secondary"
            data-action="decline"
            data-testid="decline-btn"
          >
            Decline
          </button>
          <button
            type="button"
            class="privacy-banner-btn privacy-banner-btn-primary"
            data-action="accept"
            data-testid="accept-btn"
          >
            Accept All
          </button>
          <button
            type="button"
            class="privacy-banner-btn privacy-banner-btn-tertiary"
            data-action="customize"
            data-testid="customize-btn"
          >
            Customize
          </button>
        </div>
      )}

      {variant === 'detailed' && (
        <div class="privacy-banner-actions-detailed">
          <div class="privacy-banner-actions-primary">
            <button
              type="button"
              class="privacy-banner-btn privacy-banner-btn-primary"
              data-action="accept"
              data-testid="accept-btn"
            >
              Accept All Cookies
            </button>
            <button
              type="button"
              class="privacy-banner-btn privacy-banner-btn-secondary"
              data-action="decline"
              data-testid="decline-btn"
            >
              Decline Non-Essential
            </button>
          </div>
          <div class="privacy-banner-actions-secondary">
            <button
              type="button"
              class="privacy-banner-btn privacy-banner-btn-tertiary"
              data-action="customize"
              data-testid="customize-btn"
            >
              Manage Preferences
            </button>
          </div>
        </div>
      )}

      <!-- Close button for all variants -->
      {showCloseButton && variant !== 'minimal' && (
        <button
          type="button"
          class="privacy-banner-btn privacy-banner-btn-close"
          data-action="close"
          data-testid="close-btn"
          aria-label="Close privacy notice"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      )}
    </div>
  </div>

  <!-- Progress indicator (for auto-hide) -->
  {autoHide && (
    <div class="privacy-banner-progress" data-testid="auto-hide-progress">
      <div class="privacy-banner-progress-bar"></div>
    </div>
  )}
</div>

<!-- Styles for Privacy Banner -->
<style>
  /* Privacy Banner Variables */
  .privacy-banner {
    --banner-primary: #00ffff;
    --banner-primary-hover: #00e6e6;
    --banner-secondary: #64748b;
    --banner-secondary-hover: #475569;
    --banner-background: #1a1a2e;
    --banner-surface: #16213e;
    --banner-border: #0f172a;
    --banner-text: #f1f5f9;
    --banner-text-muted: #cbd5e1;
    --banner-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.25);
    --banner-radius: 8px;
    --banner-transition: all 0.2s ease-in-out;
  }

  /* Light theme */
  .privacy-banner[data-theme="light"] {
    --banner-primary: #0ea5e9;
    --banner-primary-hover: #0284c7;
    --banner-background: #ffffff;
    --banner-surface: #f8fafc;
    --banner-border: #e2e8f0;
    --banner-text: #1e293b;
    --banner-text-muted: #64748b;
    --banner-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
  }

  /* Auto theme */
  @media (prefers-color-scheme: light) {
    .privacy-banner[data-theme="auto"] {
      --banner-primary: #0ea5e9;
      --banner-primary-hover: #0284c7;
      --banner-background: #ffffff;
      --banner-surface: #f8fafc;
      --banner-border: #e2e8f0;
      --banner-text: #1e293b;
      --banner-text-muted: #64748b;
      --banner-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
  }

  /* Banner Base Styles */
  .privacy-banner {
    position: fixed;
    left: 0;
    right: 0;
    background: var(--banner-background);
    border: 1px solid var(--banner-border);
    box-shadow: var(--banner-shadow);
    backdrop-filter: blur(8px);
    z-index: 900;
    font-family: inherit;
    color: var(--banner-text);
    animation: slideIn 0.3s ease-out;
  }

  .privacy-banner[data-position="bottom"] {
    bottom: 0;
  }

  .privacy-banner[data-position="top"] {
    top: 0;
  }

  /* Content Layout */
  .privacy-banner-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
  }

  /* Variant-specific layouts */
  .privacy-banner[data-variant="minimal"] .privacy-banner-content {
    padding: 0.75rem 1rem;
    align-items: center;
  }

  .privacy-banner[data-variant="standard"] .privacy-banner-content {
    padding: 1rem 1.25rem;
  }

  .privacy-banner[data-variant="detailed"] .privacy-banner-content {
    padding: 1.5rem;
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
  }

  /* Icon Styles */
  .privacy-banner-icon {
    color: var(--banner-primary);
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  .privacy-banner[data-variant="minimal"] .privacy-banner-icon {
    margin-top: 0;
  }

  /* Text Content */
  .privacy-banner-text {
    flex: 1;
    line-height: 1.5;
  }

  .privacy-banner-message {
    margin: 0;
    font-size: 0.875rem;
  }

  .privacy-banner[data-variant="detailed"] .privacy-banner-message {
    font-size: 0.9rem;
  }

  .privacy-banner-message p {
    margin: 0 0 0.5rem 0;
  }

  .privacy-banner-message p:last-child {
    margin-bottom: 0;
  }

  .privacy-banner-submessage {
    color: var(--banner-text-muted);
    font-size: 0.8rem;
  }

  .privacy-banner-title {
    color: var(--banner-text);
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
  }

  .privacy-banner-list {
    margin: 0.5rem 0;
    padding-left: 1.25rem;
    color: var(--banner-text-muted);
  }

  .privacy-banner-list li {
    margin-bottom: 0.25rem;
  }

  .privacy-banner-footer {
    color: var(--banner-text-muted);
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }

  .privacy-banner-link {
    color: var(--banner-primary);
    text-decoration: underline;
    font-weight: 500;
  }

  .privacy-banner-link:hover {
    color: var(--banner-primary-hover);
  }

  /* Actions Container */
  .privacy-banner-actions {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .privacy-banner[data-variant="detailed"] .privacy-banner-actions {
    align-self: stretch;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Action Groups */
  .privacy-banner-actions-minimal,
  .privacy-banner-actions-standard {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .privacy-banner-actions-detailed {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    width: 100%;
  }

  .privacy-banner-actions-primary,
  .privacy-banner-actions-secondary {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
  }

  /* Button Styles */
  .privacy-banner-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: var(--banner-radius);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--banner-transition);
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    min-height: 36px;
  }

  .privacy-banner[data-variant="minimal"] .privacy-banner-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
    min-height: 32px;
  }

  .privacy-banner-btn-primary {
    background: var(--banner-primary);
    color: var(--banner-background);
  }

  .privacy-banner-btn-primary:hover,
  .privacy-banner-btn-primary:focus {
    background: var(--banner-primary-hover);
    transform: translateY(-1px);
  }

  .privacy-banner-btn-secondary {
    background: var(--banner-secondary);
    color: var(--banner-text);
  }

  .privacy-banner-btn-secondary:hover,
  .privacy-banner-btn-secondary:focus {
    background: var(--banner-secondary-hover);
  }

  .privacy-banner-btn-tertiary {
    background: transparent;
    color: var(--banner-text-muted);
    border: 1px solid var(--banner-border);
  }

  .privacy-banner-btn-tertiary:hover,
  .privacy-banner-btn-tertiary:focus {
    background: var(--banner-surface);
    color: var(--banner-text);
  }

  .privacy-banner-btn-close {
    background: transparent;
    color: var(--banner-text-muted);
    padding: 0.25rem;
    min-height: auto;
    border-radius: 4px;
  }

  .privacy-banner-btn-close:hover,
  .privacy-banner-btn-close:focus {
    background: var(--banner-surface);
    color: var(--banner-text);
  }

  /* Progress Bar (Auto-hide) */
  .privacy-banner-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--banner-border);
    overflow: hidden;
  }

  .privacy-banner-progress-bar {
    height: 100%;
    background: var(--banner-primary);
    width: 0%;
    transition: width linear;
  }

  /* Animations */
  @keyframes slideIn {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .privacy-banner[data-position="top"] {
    animation-name: slideInFromTop;
  }

  @keyframes slideInFromTop {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(100%);
      opacity: 0;
    }
  }

  .privacy-banner[data-position="top"].hiding {
    animation-name: slideOutToTop;
  }

  @keyframes slideOutToTop {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(-100%);
      opacity: 0;
    }
  }

  .privacy-banner.hiding {
    animation: slideOut 0.3s ease-in-out forwards;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .privacy-banner-content {
      flex-direction: column;
      gap: 1rem;
    }

    .privacy-banner[data-variant="minimal"] .privacy-banner-content {
      flex-direction: row;
      gap: 0.5rem;
    }

    .privacy-banner[data-variant="standard"] .privacy-banner-content,
    .privacy-banner[data-variant="detailed"] .privacy-banner-content {
      padding: 1rem;
    }

    .privacy-banner-actions-standard,
    .privacy-banner-actions-primary,
    .privacy-banner-actions-secondary {
      flex-wrap: wrap;
      justify-content: center;
    }

    .privacy-banner-btn {
      flex: 1;
      min-width: 120px;
    }

    .privacy-banner[data-variant="minimal"] .privacy-banner-btn {
      flex: none;
      min-width: auto;
    }

    .privacy-banner-text {
      order: -1;
    }

    .privacy-banner-actions {
      order: 1;
      width: 100%;
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .privacy-banner-actions-standard {
      flex-direction: column;
      width: 100%;
    }

    .privacy-banner-btn {
      width: 100%;
    }

    .privacy-banner-message {
      font-size: 0.8rem;
    }

    .privacy-banner-list {
      font-size: 0.8rem;
    }
  }

  /* Focus Management */
  .privacy-banner :focus {
    outline: 2px solid var(--banner-primary);
    outline-offset: 2px;
  }

  /* High Contrast Mode */
  @media (prefers-contrast: high) {
    .privacy-banner {
      --banner-border: currentColor;
    }

    .privacy-banner-btn {
      border: 1px solid currentColor;
    }
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .privacy-banner,
    .privacy-banner * {
      animation-duration: 0.01ms !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Hidden State */
  [hidden] {
    display: none !important;
  }
</style>

<!-- Client-side JavaScript for Privacy Banner -->
<script>
  // Import consent management functions
  import {
    initializeConsent,
    updateConsent,
    shouldShowConsentBanner,
    markConsentBannerShown,
    respectDoNotTrack
  } from '../../lib/analytics/consent.js';

  class PrivacyBanner {
    private banner: HTMLElement;
    private progressBar: HTMLElement | null;
    private autoHideTimer: number | null = null;
    private progressTimer: number | null = null;

    constructor(bannerId: string, autoHide: boolean, autoHideDelay: number) {
      this.banner = document.getElementById(bannerId) as HTMLElement;
      this.progressBar = this.banner?.querySelector('.privacy-banner-progress-bar') as HTMLElement;

      if (!this.banner) return;

      this.init(autoHide, autoHideDelay);
    }

    private init(autoHide: boolean, autoHideDelay: number) {
      // Initialize consent system
      initializeConsent();

      // Check if banner should be shown
      if (shouldShowConsentBanner() && !respectDoNotTrack()) {
        this.show();

        // Set up auto-hide if enabled
        if (autoHide && autoHideDelay > 0) {
          this.startAutoHide(autoHideDelay);
        }
      }

      // Set up event listeners
      this.setupEventListeners();
    }

    private setupEventListeners() {
      // Button clicks
      this.banner.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const button = target.closest('[data-action]') as HTMLElement;

        if (!button) return;

        const action = button.getAttribute('data-action');

        // Stop auto-hide when user interacts
        this.stopAutoHide();

        switch (action) {
          case 'accept':
            this.handleAccept();
            break;
          case 'decline':
            this.handleDecline();
            break;
          case 'customize':
            this.handleCustomize();
            break;
          case 'close':
            this.handleClose();
            break;
        }
      });

      // Pause auto-hide on hover/focus
      this.banner.addEventListener('mouseenter', () => {
        this.pauseAutoHide();
      });

      this.banner.addEventListener('mouseleave', () => {
        this.resumeAutoHide();
      });

      this.banner.addEventListener('focusin', () => {
        this.pauseAutoHide();
      });

      this.banner.addEventListener('focusout', () => {
        this.resumeAutoHide();
      });
    }

    private show() {
      this.banner.hidden = false;

      // Focus management for accessibility
      const firstButton = this.banner.querySelector('button') as HTMLElement;
      if (firstButton) {
        // Small delay to ensure animation starts
        setTimeout(() => {
          firstButton.focus();
        }, 100);
      }
    }

    private hide() {
      this.banner.classList.add('hiding');

      setTimeout(() => {
        this.banner.hidden = true;
        this.banner.classList.remove('hiding');
      }, 300);

      markConsentBannerShown();
    }

    private handleAccept() {
      updateConsent('full', undefined, 'banner_accept');
      this.hide();
    }

    private handleDecline() {
      updateConsent('essential', undefined, 'banner_reject');
      this.hide();
    }

    private handleCustomize() {
      // Trigger consent manager modal
      const consentManager = document.querySelector('[data-testid="consent-manager"]') as HTMLElement;
      const customizeBtn = consentManager?.querySelector('[data-action="customize"]') as HTMLElement;

      if (customizeBtn) {
        customizeBtn.click();
      }

      this.hide();
    }

    private handleClose() {
      this.hide();
    }

    private startAutoHide(delay: number) {
      if (this.progressBar) {
        this.progressBar.style.transitionDuration = `${delay}ms`;
        this.progressBar.style.width = '100%';
      }

      this.autoHideTimer = window.setTimeout(() => {
        this.hide();
      }, delay);
    }

    private stopAutoHide() {
      if (this.autoHideTimer) {
        clearTimeout(this.autoHideTimer);
        this.autoHideTimer = null;
      }

      if (this.progressBar) {
        this.progressBar.style.transitionDuration = '0ms';
        this.progressBar.style.width = '0%';
      }
    }

    private pauseAutoHide() {
      if (this.progressBar && this.autoHideTimer) {
        this.progressBar.style.animationPlayState = 'paused';
      }
    }

    private resumeAutoHide() {
      if (this.progressBar && this.autoHideTimer) {
        this.progressBar.style.animationPlayState = 'running';
      }
    }
  }

  // Initialize privacy banner when DOM is ready
  const initBanner = () => {
    const bannerId = document.querySelector('[data-testid="privacy-banner"]')?.id;
    if (!bannerId) return;

    const bannerElement = document.getElementById(bannerId);
    const autoHide = bannerElement?.hasAttribute('data-auto-hide') || false;
    const autoHideDelay = parseInt(bannerElement?.getAttribute('data-auto-hide-delay') || '10000');

    new PrivacyBanner(bannerId, autoHide, autoHideDelay);
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBanner);
  } else {
    initBanner();
  }
</script>